#!gmake
#
# Makefile for nss client

CC = @CC@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
includedir = @includedir@
libdir = @libdir@
VPATH = @srcdir@
srcdir = @srcdir@
builddir = @builddir@
INSTALLCMD = @INSTALL@
CPPFLAGS = @CPPFLAGS@
CFLAGS = $(CPPFLAGS) @CFLAGS@
LDFLAGS = @LDFLAGS@
EXEEXT = @EXEEXT@
SHLD = @SHLD@
SHLD_FLAGS = @SHLD_FLAGS@
PACKAGE_VERSION = @PACKAGE_VERSION@
PICFLAG = @PICFLAG@
SHLIBEXT = @SHLIBEXT@
LIB_PATH_VAR = @LIB_PATH_VAR@

NSS_SSS_SOLIB = libnss_sss.$(SHLIBEXT).$(PACKAGE_VERSION)
NSS_SSS_SONAME = libnss_sss.$(SHLIBEXT).2

NSS_SSS_OBJS = common.o passwd.o group.o

PAM_SSS_SOLIB = pam_sss.$(SHLIBEXT)
PAM_SSS_OBJS = pam_sss.o common.o 
PAM_LIBS = -lpam -lpam_misc
PAM_CFLAGS = -DDEBUG -g -Wall -Werror

PAM_CLIENT = pam_test_client
PAM_CLIENT_OBJS = pam_test_client.o

default: all

showflags:
	@echo 'Compile flags:'
	@echo '  CFLAGS = $(CFLAGS)'
	@echo '  CPPFLAGS = $(CPPFLAGS)'
	@echo '  LDFLAGS = $(LDFLAGS)'
	@echo '  LIBS = $(LIBS)'

.SUFFIXES: .c .o

.c.o:
	@echo Compiling $*.c
	@$(CC) $(PICFLAG) $(CFLAGS) -c $< -o $@

$(NSS_SSS_SOLIB): $(NSS_SSS_OBJS)
	$(SHLD) $(SHLD_FLAGS) -o $@ $(NSS_SSS_OBJS) @SONAMEFLAG@$(NSS_SSS_SONAME)

$(NSS_SSS_SONAME): $(NSS_SSS_SOLIB)
	ln -fs $< $@

pam_sss.o: pam_sss.c
	@echo Compiling $*.c
	@$(CC) $(PICFLAG) $(CFLAGS) $(PAM_CFLAGS) -c $< -o $@

$(PAM_CLIENT): $(PAM_CLIENT_OBJS)
	@$(CC) $(CFLAGS) $(PAM_CFLAGS) $< -o $@ $(PAM_LIBS) 

$(PAM_SSS_SOLIB): $(PAM_SSS_OBJS)
	$(SHLD) $(SHLD_FLAGS) -o $@ $(PAM_SSS_OBJS) $(PAM_LIBS)

all: showflags $(NSS_SSS_OBJS) $(NSS_SSS_SOLIB) $(NSS_SSS_SONAME) $(PAM_SSS_SOLIB) $(PAM_CLIENT)

install: all
	$(INSTALLCMD) -m 755 $(NSS_SSS_SOLIB) /lib
	$(INSTALLCMD) -m 755 $(NSS_SSS_SONAME) /lib

clean:
	rm -f *.o *.a */*.o
	rm -f $(NSS_SSS_SOLIB) $(NSS_SSS_SONAME) $(PAM_SSS_SOLIB) $(PAM_CLIENT)

distclean: clean
	rm -f config.log config.status config.h config.cache
	rm -f Makefile
	rm -f *~ */*~

realdistclean: distclean
	rm -f configure config.h.in

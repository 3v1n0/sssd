#!gmake
#
CC = @CC@
prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
includedir = @includedir@
libdir = @libdir@
libexecdir = @libexecdir@
bindir = @bindir@
sbindir = @sbindir@
mandir = @mandir@
VPATH = @srcdir@:@libreplacedir@
srcdir = @srcdir@
builddir = @builddir@
sharedbuilddir = @sharedbuilddir@
INSTALLCMD = @INSTALL@
EXTRA_OBJ=@EXTRA_OBJ@
SSSD_LIBEXEC_PATH = @SSSD_LIBEXEC_PATH@
PACKAGE_VERSION = @PACKAGE_VERSION@
srvdir = $(srcdir)

TALLOC_LIBS = @TALLOC_LIBS@
TALLOC_CFLAGS = @TALLOC_CFLAGS@

TDB_LIBS = @TDB_LIBS@
TDB_CFLAGS = @TDB_CFLAGS@

EVENTS_LIBS = @EVENTS_LIBS@
EVENTS_CFLAGS = @EVENTS_CFLAGS@

POPT_LIBS = @POPT_LIBS@
POPT_CFLAGS = @POPT_CFLAGS@

LDB_LIBS = @LDB_LIBS@
LDB_CFLAGS = @LDB_CFLAGS@

DBUS_LIBS = @DBUS_LIBS@
DBUS_CFLAGS = @DBUS_CFLAGS@

CHECK_LIBS = @CHECK_LIBS@
CHECK_CFLAGS = @CHECK_CFLAGS@

LIBDL = @LIBDL@

SHLIBEXT = @SHLIBEXT@

LD_EXPORT_DYNAMIC = @LD_EXPORT_DYNAMIC@
SHLD = @SHLD@
SHLD_FLAGS = @SHLD_FLAGS@

LDFLAGS += @LDFLAGS@ -L$(srcdir)/lib
LIBS = @LIBS@ $(TALLOC_LIBS) $(TDB_LIBS) $(EVENTS_LIBS) $(POPT_LIBS) $(LDB_LIBS) $(DBUS_LIBS)

PICFLAG = @PICFLAG@
CFLAGS += -g -I$(srcdir)/include -Iinclude -I$(srcdir) -I$(srcdir)/.. \
       $(POPT_CFLAGS) $(TALLOC_CFLAGS) $(TDB_CFLAGS) $(EVENTS_CFLAGS) $(LDB_CFLAGS) $(DBUS_CFLAGS) $(CHECK_CFLAGS)\
	-DLIBDIR=\"$(libdir)\" -DSHLIBEXT=\"$(SHLIBEXT)\" -DSSSD_LIBEXEC_PATH=\"$(SSSD_LIBEXEC_PATH)\" -DUSE_MMAP=1 @CFLAGS@

MDLD = @MDLD@
MDLD_FLAGS = @MDLD_FLAGS@

default: all

include $(srvdir)/rules.mk
include $(srvdir)/server.mk

OBJS = $(SERVER_OBJ) @LIBREPLACEOBJ@ $(EXTRA_OBJ)

headers =

DBUS_SYSBUS_POLICY_DIR = @sysbuspath@

LIBEXECBINS =  sbin/sssd_nss sbin/sssd_dp sbin/sssd_be sbin/sssd_info sbin/sssd_pk
DBUS_SYSBUS_POLICIES = infopipe/org.freeipa.sssd.infopipe.conf
BINS = sbin/sssd $(LIBEXECBINS)
SOLIBS = lib/libsysdb.$(SHLIBEXT) lib/libsss_proxy.$(SHLIBEXT) lib/memberof.$(SHLIBEXT)
TESTS = tests/sysdb-tests

DIRS = sbin lib

all: showflags dirs $(OBJS) $(SOLIBS) $(BINS)

shared-build: all

tests: all $(TESTS)

dirs:
	@mkdir -p $(DIRS)

clean::
	rm -f $(OBJS) $(BINS) $(MODULES)
	rm -f *.o */*.o */*/*.o
	rm -f $(BINS) $(SOLIBS) $(TESTS)

distclean:: clean
	rm -rf $(DIRS)
	rm -f config.log config.status config.cache config.h
	rm -f Makefile

realdistclean:: distclean
	rm -f configure config.h.in

install:: all installdirs installheaders installlibs installbin installsupport
	${INSTALLCMD} -d $(DESTDIR)$(sbindir)
	${INSTALLCMD} -m 755 sbin/sssd $(DESTDIR)$(sbindir)
	${INSTALLCMD} -d $(DESTDIR)$(SSSD_LIBEXEC_PATH)
	${INSTALLCMD} -m 755 $(LIBEXECBINS) $(DESTDIR)$(SSSD_LIBEXEC_PATH)
	${INSTALLCMD} -m 755 lib/sysdb.$(SHLIBEXT) $(DESTDIR)$(libdir)
	${INSTALLCMD} -m 755 lib/libsss_proxy.$(SHLIBEXT) $(DESTDIR)$(libdir)
	${INSTALLCMD} -m 755 lib/memberof.$(SHLIBEXT) $(DESTDIR)$(libdir)

installdirs::
	mkdir -p $(DESTDIR)$(includedir) $(DESTDIR)$(libdir) $(DESTDIR)$(sbindir) $(DBUS_SYSBUS_POLICY_DIR)

installheaders:: installdirs
ifneq (x$(headers), x)
	cp $(headers) $(DESTDIR)$(includedir)
endif

installlibs:: installdirs
ifneq (x$(STATICLIB)$(LIBSOLIB), x)
	cp $(STATICLIB) $(LIBSOLIB) $(DESTDIR)$(libdir)
endif

installbin:: installdirs

installsupport:: installdirs
	cp $(DBUS_SYSBUS_POLICIES) $(DBUS_SYSBUS_POLICY_DIR)
